<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Store Simulation</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        html, body { width:100%; height:100%; overflow:hidden; font-family:Inter, sans-serif; }
        .container { width:90vw; max-width:1200px; height:85vh; margin:20px auto;
            display:grid; grid-template-columns:65% 17.5% 17.5%; grid-template-rows:50px 1fr 1fr 60px;
        }
        .header {
            grid-column: 1 / 4;
            grid-row: 1;
            display: grid;
            grid-template-columns: 20% 45% 17.5% 17.5%;
        }
        .header div { border:2px solid #000; display:flex; align-items:center; justify-content:center;
            font:600 24px Inter, sans-serif;
        }
        .content-left { grid-column:1; grid-row:2/4; border:2px solid #000; overflow:auto; padding:10px; }
        .content-cooking, .content-complete { border:2px solid #000; overflow:auto; padding:10px;
            display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-content:start;
        }
        .content-cooking { grid-column:2; grid-row:2; }
        .content-complete { grid-column:3; grid-row:2; }
        .order-number { width:80px; height:80px; display:flex; align-items:center; justify-content:center;
            background:#f0f0f0; border-radius:8px; font-size:36px; font-weight:bold; color:#333;
        }
        .message { grid-column:2/4; grid-row:3; border:2px solid #000; display:flex;
            align-items:center; justify-content:center; font:600 48px Inter, sans-serif;
        }
        .footer-left, .footer-right { display:flex; align-items:center; justify-content:center; gap:20px;
            border:2px solid #000;
        }
        .footer-left { grid-column:1; grid-row:4; }
        .footer-right { grid-column:2/4; grid-row:4; }
        button { background:#D9D9D9; border:none; font:600 18px Inter, sans-serif;
            padding:0.5em 1em; cursor:pointer; border-radius:4px;
        }
        .cart-sidebar { position:fixed; top:0; right:0; width:300px; height:100%; background:#fff;
            box-shadow:-2px 0 5px rgba(0,0,0,0.1); padding:20px; overflow-y:auto;
            transform:translateX(100%); transition:transform .3s ease; z-index:200;
        }
        .cart-sidebar.open { transform:translateX(0); }
        .cart-sidebar h3 { margin-top:0; font-size:1.5em; text-align:center; }
        .cart-item { display:flex; justify-content:space-between; margin-bottom:10px; }
        #openCartBtn { position:fixed; top:20px; right:20px; padding:8px 12px;
            background:#28a745; color:#fff; border-radius:4px; font-size:14px; z-index:150;
        }
        #checkoutBtn, #closeCartBtn { padding:10px; border:none; cursor:pointer;
            border-radius:4px; width:100%; font-size:16px;
        }
        #checkoutBtn { background:#007bff; color:#fff; margin-top:10px; }
        #closeCartBtn { background:#dc3545; color:#fff; margin-top:5px; }
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.5); align-items:center; justify-content:center;
            z-index:250;
        }
        .modal.open { display:flex; }
        .modal-content { background:#fff; padding:20px; width:300px;
            border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3); position:relative;
        }
        .modal-content h2 { margin-top:0; font-size:1.5em; }
        .modal-content label { display:block; margin:12px 0 4px; font-weight:500; }
        .modal-content input, .modal-content select { width:100%; padding:6px 8px;
            box-sizing:border-box; margin-bottom:8px;
        }
        .modal-content .btn-group { text-align:right; margin-top:16px; }
        .modal-content .btn-group button { margin-left:8px; }
        #editMenuBtn { position:absolute; top:10px; right:10px; padding:4px 8px; font-size:14px; }
        .menu-item button {padding: 0.5em 1em;font-size: 1rem;cursor: pointer;}
        .menu-item button:first-child {text-align: left;}
    </style>

</head>
<body>
<div class="container">
    <div class="header">
        <div>
            ì´ íŒë§¤ê¸ˆì•¡: <span id="totalSalesValue" th:text="${totalSales}">0</span>ì›
        </div>
        <div>ì£¼ë¬¸í•˜ê¸°</div>
        <div>ì¡°ë¦¬ì¤‘</div>
        <div>ì¡°ë¦¬ì™„ë£Œ</div>
    </div>
    <div class="content-left" id="orderArea"></div>
    <div class="content-cooking" id="cookingArea"></div>
    <div class="content-complete" id="completeArea"></div>
    <div class="message"> </div>
    <div class="footer-left">
        <button id="btnAdd">ë©”ë‰´ ì¶”ê°€</button>
        <button id="btnStatus">íŒë§¤ í˜„í™©</button>
    </div>
    <div class="footer-right">
        <button id="btnReceive">ìŒì‹ ë°›ê¸°</button>
    </div>
</div>
<button id="openCartBtn">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë³´ê¸°</button>
<a th:href="@{/logout}"
   id="logoutBtn"
   style="position:fixed; top:60px; right:20px; padding:8px 12px;
          background:#dc3545; color:#fff; border-radius:4px; font-size:14px;
          text-decoration:none; text-align:center; z-index:150;">
    ë¡œê·¸ì•„ì›ƒ
</a>

<div id="addModal" class="modal">
    <div class="modal-content">
        <h2>ë©”ë‰´ ì¶”ê°€</h2>
        <form id="addMenuForm">
            <label>ì´ë¦„<input type="text" name="name" required/></label>
            <label>ê°€ê²©(ì›)<input type="number" name="price" min="1" required/></label>
            <label>ì¡°ë¦¬ ì‹œê°„(ì´ˆ)<input type="number" name="makeTime" min="1" required/></label>
            <div class="btn-group">
                <button type="button" id="cancelAdd">ì·¨ì†Œ</button>
                <button type="submit">ì¶”ê°€</button>
            </div>
        </form>
    </div>
</div>

<!-- ìˆ˜ëŸ‰ ì„ íƒ ëª¨ë‹¬ -->
<div id="qtyModal" class="modal">
    <div class="modal-content">
        <button id="editMenuBtn">ë©”ë‰´ ìˆ˜ì •</button>
        <h2>ìˆ˜ëŸ‰ ì„ íƒ</h2>
        <form id="qtyForm">
            <input type="hidden" id="qtyMenuId">
            <label>ìˆ˜ëŸ‰<input type="number" id="qtyInput" min="1" value="1" required/></label>
            <div class="btn-group">
                <button type="button" id="cancelQty">ì·¨ì†Œ</button>
                <button type="submit">ë‹´ê¸°</button>
            </div>
        </form>
    </div>
</div>

<!-- ê²°ì œ ìˆ˜ë‹¨ ëª¨ë‹¬ -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <h2>ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ</h2>
        <form id="paymentForm">
            <label><input type="radio" name="paymentMethod" value="CARD" checked/> ì¹´ë“œ</label>
            <label><input type="radio" name="paymentMethod" value="CASH"/> í˜„ê¸ˆ</label>
            <div class="btn-group">
                <button type="button" id="cancelPayment">ì·¨ì†Œ</button>
                <button type="submit">í™•ì¸</button>
            </div>
        </form>
    </div>
</div>

<!-- ë©”ë‰´ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h2>ë©”ë‰´ ìˆ˜ì •</h2>
        <form id="editForm">
            <input type="hidden" id="editMenuId">
            <label>ì´ë¦„<input type="text" id="editName" required/></label>
            <label>ê°€ê²©(ì›)<input type="number" id="editPrice" min="1" required/></label>
            <label>ì¡°ë¦¬ ì‹œê°„(ì´ˆ)<input type="number" id="editMakeTime" min="1" required/></label>
            <div class="btn-group">
                <button type="button" id="cancelEdit">ì·¨ì†Œ</button>
                <button type="button" id = "saveEditBtn">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>

<!-- ì¥ë°”êµ¬ë‹ˆ ì‚¬ì´ë“œë°” -->
<div id="cartSidebar" class="cart-sidebar">
    <h3>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h3>
    <ul id="cartItems" style="list-style:none;padding:0;"></ul>
    <div id="cartTotal" style="margin-top:20px;font-weight:bold;">ì´í•©: 0ì›</div>
    <button id="checkoutBtn">ì£¼ë¬¸í•˜ê¸°</button>
    <button id="closeCartBtn">ë‹«ê¸°</button>
    <button onclick="clearCart()">ì¥ë°”êµ¬ë‹ˆ ì´ˆê¸°í™”</button>
</div>

<div id="salesModal" class="modal">
    <div class="modal-content">
        <h2>íŒë§¤ í˜„í™©</h2>
        <table id="salesTable" style="width:100%; border-collapse:collapse;">
            <thead>
            <tr>
                <th style="border:1px solid #ddd; padding:8px;">ë©”ë‰´</th>
                <th style="border:1px solid #ddd; padding:8px;">íŒë§¤ ìˆ˜ëŸ‰</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="btn-group" style="text-align:right; margin-top:16px;">
            <button id="closeSalesBtn">ë‹«ê¸°</button>
        </div>
    </div>
</div>


<script>
    const cart = [];
    const ordersInProgress = [];
    const completedOrders = [];

    function loadMenus() {
        fetch('/api/menus')
            .then(res => res.json())
            .then(menus => {
                const area = document.getElementById('orderArea');
                area.innerHTML = '';

                menus.forEach(menu => {
                    const box = document.createElement('div');
                    box.className = 'menu-item';
                    box.style.display = 'flex';
                    box.style.alignItems = 'center';
                    box.style.justifyContent = 'space-between';
                    box.style.margin = '8px 0';

                    const orderBtn = document.createElement('button');
                    orderBtn.textContent = `${menu.name} (${menu.price}ì›)`;
                    orderBtn.style.flex = '1';
                    orderBtn.dataset.id = menu.menuId;
                    orderBtn.dataset.name = menu.name;
                    orderBtn.dataset.price = menu.price;
                    orderBtn.dataset.makeTime = menu.makeTime;
                    orderBtn.onclick = () => openQtyModal(menu);

                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'ğŸ—‘ï¸';
                    delBtn.style.marginLeft = '8px';
                    delBtn.title = 'ë©”ë‰´ ì‚­ì œ';
                    delBtn.onclick = async () => {
                        if (!confirm(`"${menu.name}" ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                        const res = await fetch(`/api/menus/${menu.menuId}`, { method: 'DELETE' });
                        if (res.ok) {
                            loadMenus();
                        } else {
                            alert('ì‚­ì œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    };

                    box.append(orderBtn, delBtn);
                    area.appendChild(box);
                });
            });
    }

    function toggleModal(id, open) {
        document.getElementById(id).classList[open ? 'add' : 'remove']('open');
    }

    function openQtyModal(menu) {
        document.getElementById('qtyMenuId').value = menu.menuId;
        document.getElementById('qtyInput').value = 1;
        document.getElementById('qtyModal').dataset.currentMenu = JSON.stringify(menu);

        toggleModal('qtyModal', true);

        const editBtn = document.getElementById('editMenuBtn');
        editBtn.onclick = () => {
            document.getElementById('editMenuId').value     = menu.menuId;
            document.getElementById('editName').value       = menu.name;
            document.getElementById('editPrice').value      = menu.price;
            document.getElementById('editMakeTime').value   = menu.makeTime;
            toggleModal('editModal', true);
        };
    }

    document.getElementById('btnAdd').onclick = () => {
        toggleModal('addModal', true);
    };

    document.getElementById('cancelAdd').onclick = () => {
        toggleModal('addModal', false);
    };

    document.getElementById('addMenuForm').onsubmit = e => {
        e.preventDefault();

        const name     = e.target.name.value.trim();
        const price    = +e.target.price.value;
        const makeTime = +e.target.makeTime.value;

        fetch('/api/menus', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, price, makeTime })
        })
            .then(res => {
                if (!res.ok) throw new Error('ë©”ë‰´ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                return res.json();
            })
            .then(() => {
                toggleModal('addModal', false);
                loadMenus();
            })
            .catch(err => {
                console.error(err);
                alert(err.message);
            });
    };

    document.getElementById('cancelQty').onclick = () => toggleModal('qtyModal', false);
    document.getElementById('qtyForm').onsubmit = e => {
        e.preventDefault();
        const id = +document.getElementById('qtyMenuId').value;
        const qty = +document.getElementById('qtyInput').value;
        const btn = Array.from(document.querySelectorAll(`[data-id]`)).find(b => +b.dataset.id === id);
        const name = btn.dataset.name;
        const price = +btn.dataset.price;
        const makeTime = +btn.dataset.makeTime;
        const exist = cart.find(i => i.menuId === id);
        if (exist) exist.quantity += qty;
        else cart.push({ menuId: id, name, price, quantity: qty, makeTime });
        renderCart();
        toggleModal('qtyModal', false);
    };

    function renderCart() {
        const ul = document.getElementById('cartItems'); ul.innerHTML = '';
        let total = 0;
        cart.forEach(item => {
            total += item.price * item.quantity;
            const li = document.createElement('li'); li.className = 'cart-item';
            li.innerHTML = `<span>${item.name} x ${item.quantity}</span><span>${item.price * item.quantity}ì›</span>`;
            ul.appendChild(li);
        });
        document.getElementById('cartTotal').textContent = `ì´í•©: ${total}ì›`;
    }

    document.getElementById('checkoutBtn').onclick = () => {
        if (!cart.length) return alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
        toggleModal('paymentModal', true);
    };
    document.getElementById('cancelPayment').onclick = () => toggleModal('paymentModal', false);

    document.getElementById('paymentForm').onsubmit = async e => {
        e.preventDefault();
        const method = document.querySelector('input[name="paymentMethod"]:checked').value;
        const cookingTime = cart.reduce((sum, i) => sum + i.makeTime * i.quantity, 0);

        try {
            const resOrder = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: cart.map(i => ({ menuId: i.menuId, quantity: i.quantity })),
                    paymentMethod: method
                })
            });
            if (!resOrder.ok) throw new Error('ì£¼ë¬¸ ì‹¤íŒ¨');
            const orderId = await resOrder.json();

            ordersInProgress.push({ orderId, cookingTime });
            renderOrders();

            setTimeout(() => {
                const idx = ordersInProgress.findIndex(o => o.orderId === orderId);
                if (idx > -1) {
                    completedOrders.push(ordersInProgress[idx]);
                    ordersInProgress.splice(idx, 1);
                    renderOrders();
                }
            }, cookingTime * 1000);

            cart.length = 0;
            renderCart();
            toggleModal('cartSidebar', false);
            alert(`ì£¼ë¬¸ ì™„ë£Œ! ì£¼ë¬¸ë²ˆí˜¸: ${orderId}`);

            const resSales = await fetch('/api/orders/total-sales');
            if (!resSales.ok) throw new Error('ì´íŒë§¤ê¸ˆì•¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
            const newTotal = await resSales.json();
            document.getElementById('totalSalesValue').textContent = newTotal;

        } catch (err) {
            console.error(err);
            alert(err.message);
        } finally {
            toggleModal('paymentModal', false);
        }
    };


    function clearCart() {
        fetch('/api/cart/clear', {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    alert("ì¥ë°”êµ¬ë‹ˆê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                } else {
                    alert("ì´ˆê¸°í™” ì‹¤íŒ¨");
                }
            });
    }

    async function createOrder(payload) {
        const res = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('ì£¼ë¬¸ ì‹¤íŒ¨');

        const totalRes = await fetch('/api/orders/total-sales');
        const newTotal = await totalRes.json();

        document.getElementById('totalSalesValue').textContent = newTotal;
    }

    function renderOrders() {
        const cookingArea = document.getElementById('cookingArea');
        const completeArea = document.getElementById('completeArea');
        cookingArea.innerHTML = '';
        completeArea.innerHTML = '';
        ordersInProgress.forEach(o => {
            const div = document.createElement('div');
            div.className = 'order-number';
            div.textContent = o.orderId;
            cookingArea.appendChild(div);
        });
        completedOrders.forEach(o => {
            const div = document.createElement('div');
            div.className = 'order-number';
            div.textContent = o.orderId;
            completeArea.appendChild(div);
        });
        const msg = document.querySelector('.message');
        if (completedOrders.length > 0) {
            msg.textContent = 'ìŒì‹ ë‚˜ì™”ìŠµë‹ˆë‹¤';
        } else {
            msg.textContent = '';
        }
    }

    document.getElementById('btnReceive').onclick = () => {
        if (!completedOrders.length) return alert('ë°›ì„ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.');
        completedOrders.length = 0;
        renderOrders();
        alert('ëª¨ë“  ìŒì‹ì´ ìˆ˜ë ¹ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    document.getElementById('openCartBtn').onclick = () => toggleModal('cartSidebar', true);
    document.getElementById('closeCartBtn').onclick = () => toggleModal('cartSidebar', false);

    document.getElementById('editMenuBtn').onclick = () => {
        const menu = JSON.parse(document.getElementById('qtyModal').dataset.currentMenu);
        document.getElementById('editMenuId').value = menu.menuId;
        document.getElementById('editName').value = menu.name;
        document.getElementById('editPrice').value = menu.price;
        document.getElementById('editMakeTime').value = menu.makeTime;
        toggleModal('editModal', true);
    };

    loadMenus();

    document.getElementById('cancelEdit').onclick = () => toggleModal('editModal', false);
    document.getElementById('saveEditBtn').onclick = () => {
        const id = +document.getElementById('editMenuId').value;
        const name = document.getElementById('editName').value;
        const price = +document.getElementById('editPrice').value;
        const makeTime = +document.getElementById('editMakeTime').value;

        fetch(`/api/menus/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ menuId: id, name, price, makeTime })
        })
            .then(res => {
                if (!res.ok) throw new Error('ë©”ë‰´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                return res;
            })
            .then(() => {
                alert(`ë©”ë‰´(${id})ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                toggleModal('editModal', false);
                loadMenus();
            })
            .catch(err => {
                console.error(err);
                alert(err.message);
            });
    };

    document.getElementById('btnStatus').onclick = async () => {
        try {
            const res = await fetch('/api/menus/sales-summary');
            if (!res.ok) throw new Error('íŒë§¤ í˜„í™© ë¡œë“œ ì‹¤íŒ¨');
            const list = await res.json();

            const tbody = document.querySelector('#salesTable tbody');
            tbody.innerHTML = '';

            list.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td style="border:1px solid #ddd; padding:8px;">${item.name}</td>
        <td style="border:1px solid #ddd; padding:8px; text-align:right;">${item.quantity}</td>
      `;
                tbody.appendChild(tr);
            });

            document.getElementById('salesModal').classList.add('open');
        } catch (err) {
            console.error(err);
            alert(err.message);
        }
    };

    document.getElementById('closeSalesBtn').onclick = () => {
        document.getElementById('salesModal').classList.remove('open');
    };

</script>
</body>
</html>
